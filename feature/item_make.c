// 动态装备的一些随机参数 By Wenwu

#define OUT_SET_SX 50
#include <ansi.h>

inherit F_COLOR;

#include <item_sx.h>

// 颜色
nosave string *ansi_arg = ({
	RED, GRN, YEL, BLU, MAG, CYN, WHT, HIR, HIG, HIY, HIB, HIM, HIC, HIW
	});

// 名称
nosave mapping name_id_arg = ([
	"失神" : "shishen",
	"炽日" : "zhiri",
	"弑神" : "shishen",
	"怜星" : "lianxing",
	"无神" : "wushen",
	"邀月" : "yaoyue",
	"噬魔" : "shimo",
	"月霞" : "yuexia",
	"除魔" : "chumo",
	"神风" : "shenfeng",
	"空绝" : "kongjue",
	"月洁" : "yuejie",
	"风行" : "fengxing",
	"凌风" : "lingfeng",
	"飞花" : "feihua",
	"逐月" : "zhuyue",
	"飘星" : "piaoxing",
	"炫星" : "xuanxing",
	"蝶舞" : "diewu",
	"空寂" : "kongji",
	"飘月" : "piaoyue",
	"灵风" : "lingfeng",
	"梦神" : "mengshen",
	"断情" : "duanqing",
	"追星" : "zhuixing",
	"灵慧" : "linghui",
	"傲雪" : "aoxue",
	"吟龙" : "yinlong",
	"残月" : "canyue",
	"定风" : "dingfeng",
	"浩光" : "haoguang",
	"情义" : "qingyi",
	"毫光" : "haoguang",
	"灵星" : "lingxing",
	"七星" : "qixing",
	"断月" : "duanyue",
	"追云" : "zhuiyun",
	"豪情" : "haoqing",
	"剑心" : "jianxin",
	"凌云" : "lingyun",
	"龙形" : "longxing",
	"碎心" : "suixin",
	"断脉" : "duanmai",
	"绝情" : "jueqing",
	"破空" : "pokong",
	"斩魔" : "zhanmo",
	"乾坤" : "qiankun",
	"鸿星" : "hongxing",
	"断空" : "duankong",
	"掠影" : "lueying",
	"幻影" : "huanying",
	"谰星" : "lanxing",
	"滚龙" : "gunlong",
	"长空" : "changkong",
	"飘雪" : "piaoxue",
	"覆雨" : "fuyu",
	"翻云" : "fanyun",
	"降魔" : "xiangmo",
	"伏魔" : "fumo",
	"秋寒" : "qiuhan",
	"电光" : "dianguang",
	"雷鸣" : "leiming",
	"风雷" : "fenglei",
	"蔽日" : "biri",
	"幻魔" : "huanmo",
	"虚冥" : "xuming",
	"幽明" : "youming",
	"溟神" : "mingshen",
	"炎狱" : "yanyu",
	"焰心" : "yanxin",
	"青龙" : "qinglong",
	"风影" : "fengying",
	"偃月" : "yanyue",
	"雁行" : "yanxing",
	"龙蛇" : "longshe",
	"灵蛇" : "lingshe",
	"渺空" : "miaokong",
	"曜星" : "yaoxing",
	"望空" : "wangkong",
	"尘心" : "chenxin",
	"幻月" : "huanyue",
	"绝尘" : "juechen",
	"长恨" : "changhen",
	"驰风" : "chifeng",
	"天行" : "tianxing",
	"天罡" : "tiangang",
	"地煞" : "disha",
	"蛟龙" : "jiaolong",
	"龙神" : "longshen",
	"长空" : "changkong",
	"冰心" : "bingxin",
	"噬谷" : "shigu",
	"风刃" : "fengren",
	"寒光" : "hanguang",
	"定心" : "dingxin",
	"幻舞" : "huanwu",
	"翌日" : "yiri",
	"玄武" : "xuanwu",
	"古锭" : "guding",
	"天玄" : "tianxuan",
	"太极" : "taiji",
	"混元" : "hunyuan",
	"天风" : "tianfeng",
	"无极" : "wuji",
]);

// 取得一个随机的名称
string get_item_name(int pj, int lvl)
{
	string name, *name_arry;
	int get_ansi, get_name1, get_name2;

	name_arry = keys(name_id_arg);
	get_ansi = random(sizeof(ansi_arg));
	get_name1 = random(sizeof(name_arry));

	get_name2 = random(sizeof(name_arry));
	while ( get_name2 == get_name1 )
	{
		get_name2 = random(sizeof(name_arry));
	}

	if ( pj < 15 && lvl < 9 )
		name = ansi_arg[get_ansi] + name_arry[get_name1];
	else
		name = ansi_arg[get_ansi] + name_arry[get_name1] + ansi_arg[get_ansi] + name_arry[get_name2];

	return name;
}

// 取得动态物品ID
string get_item_id(string name, string item_type)
{
	string id, no_ansi_name, get_id;
	int len;

	no_ansi_name = clean_color(name);
	len = strlen(no_ansi_name);
	
	if ( len > 4 )
		get_id = name_id_arg[no_ansi_name[0..3]]+ " " + name_id_arg[no_ansi_name[4..(len-1)]] + " " + item_type;
	else
		get_id = name_id_arg[no_ansi_name[0..3]] + " " + item_type;

	id = replace_string(get_id, "0", "");
	id = replace_string(id, "0 ", "");

	return id;
}

// 属性
varargs void get_item_shuxing(string item_type, int pj, int lvl, int flag)
{
	object ob;
	string *weapon, *armor;
	int m, n, out;

	ob = this_object();
	weapon = keys(weapon_shuxing);
	armor = keys(armor_shuxing);
	m = 0;
	n = 0;
	out = 0;

	switch (item_type)
	{
		case "weapon":
			if ( pj > sizeof(weapon) )
				return;
			ob->set("weapon_prop/damage", lvl * 100);
			weapon -= ({ "damage" });
			pj--;
			while ( pj && pj > 0 )
			{
				if ( out > OUT_SET_SX )
					break;
				m = sizeof(weapon);
				if ( !m || m < 1 )
					break;
				n = random(m);
				ob->set("weapon_prop/" + weapon[n], random(100 * lvl));
				weapon -= ({ weapon[n] });
				pj--;
				out++;
			}
			break;

		case "armor":
			if ( pj > sizeof(armor) )
				return;
			ob->set("armor_prop/armor", lvl * 100);
			weapon -= ({ "armor" });
			pj--;
			while ( pj && pj > 0 )
			{
				if ( out > OUT_SET_SX )
					break;
				m = sizeof(armor);
				if ( !m || m < 1 )
					break;
				n = random(m);
				ob->set("armor_prop/" + armor[n], random(100 * lvl));
				weapon -= ({ armor[n] });
				pj--;
				out++;
			}
			break;

		default:log_file( "/SET_item", sprintf("%s装备类型设置错误。\n", base_name(ob)));
	}

	// 效果增强
	/*tx = random(2);//定义随机出现带星号装备的概率，针对自身不带判定的怪。
	name = ob->query("name");
	
	if ( tx < 3 && 4 <= flag )
	{
		ob->set("xyzx_item/pinji", 4);
		ob->set("name", YEL"★" + name);
	}
	else if ( tx < 10 && 3 <= flag )
	{
		ob->set("xyzx_item/pinji", 3);
		ob->set("name", MAG"☆☆☆" + name);
	}
	else if ( tx < 50 && 2 <= flag )
	{
		ob->set("xyzx_item/pinji", 2);
		ob->set("name", BLU"☆☆" + name);
	}
	else if ( tx < 100 && 1 <= flag )
	{
		ob->set("xyzx_item/pinji", 1);
		ob->set("name", GRN"☆" + name);
	}*/
}